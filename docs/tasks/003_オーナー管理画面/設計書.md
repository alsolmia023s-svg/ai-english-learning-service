# オーナー管理画面 設計書

## 1. ユーザーニーズ
- サービスの利用状況（ユーザー数、お問合せ数）を把握したい
- 登録ユーザーを管理（権限変更、削除）したい
- お問合せ内容を確認し、対応済みかどうか管理したい（今回は削除のみで対応）

## 2. 仕様要件

### 2.1 アクセス制御
- **管理者権限**: `role: "admin"` のユーザーのみアクセス可能
- **アクセス制限**: 一般ユーザーや未ログインユーザーが `/admin` 配下にアクセスした場合は 403 Forbidden またはログイン画面へリダイレクト（今回は403エラー画面を表示）

### 2.2 機能一覧

#### (1) ダッシュボード (`/admin`)
- **統計情報表示**:
  - 総ユーザー数
  - 総お問合せ数

#### (2) ユーザー管理 (`/admin/users`)
- **一覧表示**: 登録ユーザーの一覧を表示（名前、メール、権限、登録日）
- **権限変更**: ユーザーの権限を `user` <-> `admin` で切り替え可能
- **削除**: ユーザーを削除可能

#### (3) お問合せ管理 (`/admin/contacts`)
- **一覧表示**: お問合せの一覧を表示（名前、件名、送信日時）
- **詳細表示**: お問合せの本文を表示
- **削除**: お問合せを削除可能

### 2.3 技術要件
- **UIコンポーネント**: MUI (Material UI)
  - `DataGrid`: 一覧表示用
  - `Card`: 統計情報表示用
  - `Dialog`: 確認・詳細表示用
- **API**:
  - `GET /api/admin/stats`: 統計情報取得
  - `GET /api/admin/users`: ユーザー一覧取得
  - `DELETE /api/admin/users`: ユーザー削除
  - `PATCH /api/admin/users`: ユーザー権限変更
  - `GET /api/admin/contacts`: お問合せ一覧取得
  - `DELETE /api/admin/contacts`: お問合せ削除

## 3. 処理手順設計

### 3.1 バックエンド実装
1. **APIルート作成**:
   - `src/app/api/admin/stats/route.ts`
   - `src/app/api/admin/users/route.ts`
   - `src/app/api/admin/contacts/route.ts`
2. **ミドルウェア/権限チェック**:
   - APIルート内で `auth()` を使用し、`session.user.role === 'admin'` を確認

### 3.2 フロントエンド実装
1. **レイアウト**: `src/app/admin/layout.tsx` (管理者用サイドバーまたはヘッダー)
2. **ダッシュボード**: `src/app/admin/page.tsx`
3. **ユーザー管理**: `src/app/admin/users/page.tsx`
4. **お問合せ管理**: `src/app/admin/contacts/page.tsx`

### 3.3 環境変数
- `ADMIN_EMAILS`: 初期管理者として設定するメールアドレス（カンマ区切り）
  - ※初回ログイン時に、このリストに含まれるメールアドレスのユーザーを自動的に `admin` 権限にするロジックを `auth.ts` に追加することを検討（または手動でDB書き換え）。今回は要件に従い、環境変数設定タスクがあるため、`auth.ts` の `signIn` コールバックでこの環境変数をチェックしてロールを付与する実装を追加する。

## 4. データモデル
既存の `User` モデルと `Contact` モデルを使用。
