# Google認証機能 設計書

## 1. ユーザーニーズ
- Googleアカウントを使って簡単にログインしたい
- メールアドレスとパスワードを覚える手間を省きたい
- 安全にサービスを利用したい

## 2. 仕様要件

### 2.1 認証機能
- **プロバイダー**: Google (NextAuth.js GoogleProvider)
- **ログイン**:
  - ログインボタンクリックでGoogleの認証画面へ遷移
  - 認証成功後、トップページまたはダッシュボードへリダイレクト
- **ログアウト**:
  - ヘッダーのログアウトボタンクリックでログアウト
  - ログアウト後、トップページへリダイレクト
- **セッション管理**:
  - NextAuth.jsによるセッション管理
  - JWTまたはデータベースセッション（今回はMongoDB Adapterを使用予定だが、まずはJWTで実装し、必要に応じてAdapterを追加検討。要件には「ユーザー情報をMongoDBに保存」とあるため、サインイン時のコールバックで保存するか、Adapterを使用する。今回は要件に従い、Userモデルを作成して保存するフローを実装する）

### 2.2 ユーザー情報保存
- **データベース**: MongoDB
- **コレクション**: `users`
- **保存データ**:
  - 名前 (`name`)
  - メールアドレス (`email`)
  - プロフィール画像URL (`image`)
  - 権限 (`role`): デフォルトは "user"
  - 作成日時 (`createdAt`)

### 2.3 画面・UI
- **ログイン画面 (`/auth/signin`)**:
  - Googleログインボタンを配置
- **ヘッダー**:
  - **未ログイン時**: 「ログイン」ボタン表示
  - **ログイン時**: ユーザーアバター、ユーザー名、「ログアウト」ボタン表示
- **ダッシュボード (`/dashboard`)**:
  - 認証済みユーザーのみアクセス可能
  - 未認証ユーザーがアクセスした場合はログイン画面へリダイレクト

### 2.4 セキュリティ
- **ミドルウェア**:
  - `/dashboard` 配下のルートを保護
  - 認証状態をチェックし、未認証ならリダイレクト

## 3. 処理手順設計

### 3.1 セットアップ
1. `next-auth` パッケージのインストール（v5 betaまたはv4。Next.js 15なのでv5推奨だが、安定性を考慮しv5の最新を使用）
2. Google Cloud ConsoleでOAuthクライアントIDを作成
3. 環境変数 (`.env.local`) の設定

### 3.2 バックエンド実装
1. **Userモデル作成**: `src/models/User.ts`
2. **NextAuth設定**: `src/auth.ts` (v5 style) または `src/app/api/auth/[...nextauth]/route.ts`
   - GoogleProviderの設定
   - `signIn` コールバックでMongoDBへのユーザー保存処理を実装
   - `session` コールバックでセッションに `role` などを追加

### 3.3 フロントエンド実装
1. **ログイン画面作成**: `src/app/auth/signin/page.tsx`
2. **ヘッダー改修**: `src/components/Header.tsx` (または `layout.tsx` 内)
   - セッション状態による表示切り替え
3. **ダッシュボード作成**: `src/app/dashboard/page.tsx`

### 3.4 ミドルウェア実装
1. **Middleware作成**: `src/middleware.ts`
   - `/dashboard` へのアクセス制限

## 4. データモデル (User)
```typescript
{
  name: String,
  email: String, // Unique
  image: String,
  role: { type: String, default: 'user', enum: ['user', 'admin'] },
  createdAt: Date
}
```
